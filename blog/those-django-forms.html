<!DOCTYPE html>
<html lang="en">
<head>
    <title>Those Django Forms Sat Me Down</title>
    <link rel="image_src" href="http://i.imgur.com/LwZh4ju.png" / >
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/freelancer.css" rel="stylesheet">
    <link href="../font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
    <script src="js/signals.min.js"></script>
    <script src="js/crossroads.js"></script>
    <script src="js/routes.js"></script>
    
    <meta name="keywords" content="Python, Django, Forms, Validators, IntegerField, Sublcass" />
    <meta property="og:image" content="http://i.imgur.com/LwZh4ju.png" />


    
    
</head>
<body id="page-top" class="index">
    
    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Damage Control</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                     <li class="dropdown page-scroll">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Projects <span class="caret"></span></a>
                      <ul class="dropdown-menu" role="menu">
                        <li><a href="http://tuneout.altervista.org/tune-out/">Tuneout</a></li>
                        <li><a href="#">AI. You</a></li>
                        <li class = "disabled"><a href="#">Arsonist Suite</a></li>
                      </ul>
                    </li>
                    <li class="page-scroll">
                        <a href="#blog">Blog</a>
                    </li>
                    <li class="page-scroll">
                        <a href="../about.html">About</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
    
    <div id = "content" class="blog-content">
        <div class="row">
            <div class = "col-md-3 sidebar">
                <h3>Older Blogs:</h3>
                <hr>
                <ul class="list-group">
                                        <a href="blog-3.html" class="side-links"><li class="list-group-item side-panel">The Data Cowboys - (4/4/15)</li></a>
                    <br>
                    
                    <a href="blog-2.html" class="side-links"><li class="list-group-item side-panel">Squashing the Big Bugs - (2/23/15)</li></a>
                    <br>
                    <a href="blog-1.html" class="side-links"><li class="list-group-item side-panel">Worst Programming Language - (2/12/15)</li></a>
                </ul>
                <br>
                 <h3>Share It:</h3>
                 <hr>
                <div class="fb-share-button" data-href="http://dmg-control.com/blog/" data-layout="button"></div>
                <br>
                <br>
                <a href="https://twitter.com/share" class="twitter-share-button" data-via="dmg_controlsw" data-size="large">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <br>
                <br>
                <a href="https://twitter.com/dmg_controlsw" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @dmg_controlsw</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            </div>
            <div class = "col-md-6">
                <div class = "page-header blog-post-header">
                        <h2>Those Django Forms Sat Me Down</h2>
                        <p class = "lead">(4/25/15)</p>
                        <small>by Kirt Gittens</small>
                    <hr>
                    <img src="../img/img4.png" class = "img-responsive" title="Get it? cause Django unchai... nevermind">
                    <br>
                    <div class = "blog-post">
<p>
                        So, Django got in my way earlier this week. And that's unusual, because Django is generally awesome! It's one of the most robust web frameworks I've ever seen, that manages to ship with batteries-included, and at the same time, remains simplistic without feeling bloated (<b>RAILS</b>). If you care about Python at all and haven't checked it out (the chances of this being the case should be NEARLY non-existent) definitely do so <a href = "https://code.djangoproject.com/">[Django Link]</a>. 
</p>
                        <br>
                        <blockquote>
<i>But back to the grumbling</i>
</blockquote>
                        <br>
<p>
	Django's Forms API abstracts away the work of validating a ton of related user input fields that you need to use in your application. This works great in the basic use case. Lets say you need to grab some information from a user. Works Fine:
</p>
<pre class = "brocode">
class DamageControlCommentForm(forms.Form):
		name_field = Fields.ImaginaryNameField()
		comment_field = Fields.InTheTrashField()
</pre>
                        <br>
                        <p>
	The criteria for validating your form is generally already taken care of for you with django's validation API, so all you have to do is define the criteria, like so:
</p>
                        <pre class = "brocode">
class DamageControlCommentForm(forms.Form):
    article_metacritic_score = Fields.IntegerField(
        min_value = 90 #out of 100
    )
</pre>
                        <br>
                        <p>
	And Django will take care of the work of validating the input based on the criteria you set here in the field instantiation. When you attempt to supply a value to this Form that's smaller than 90, It should throw an error that you can display in your HTML. 
                            
                            <p>It appears to work for the smaller use cases, but as your forms get larger and more complicated, and start having more complex validation requirements, you'll start running into some issues. What if I write a huge and complicated form that I don't want to have to duplicate, but need use with some slightly different validation criteria. Shouldn't I be able to just subclass the form and just change some things? Most people will try and tell you that you can! (but you can't REALLY). Let's try subclassing our form and then JUST changing some of the validation rules we need.
                                </p>
</p>
<pre class = "brocode">
#Let's assume DamageControlCommentForm has a TON of stuff in it now
# and I need to use basically the same form
# but with a few different validation attributes

class DamageControlPythonArticleComment(DamageControlCommentForm)
    def __init__(self, *args, **kwargs):
        super(DamageControlPythonArticleComment, self).__init__(*args, **kwargs)
        self.fields['article_metacritic_score'].min_value = 100 
        # Python is WAY cooler than anything else (ruby  == garbage)
</pre>

                        <p>
	This looks like it should work, but it doesn't. When you instantiate this form, and attempt to pass a max_value of 90, it WON'T throw the error like it should according to your new validation criteria for <i>DamageControlPythonArticleComment</i>. And the reason why actually isn't very well documented, you'll have to kind of dig in to the source code of django to figure it out. The code that gets run when we instantiate an IntegerField field in Django looks like this.
</p>

                        <br>
<pre class = "brocode">
def __init__(self, max_value=None, min_value=None, *args, **kwargs):
    self.max_value, self.min_value = max_value, min_value
    if kwargs.get('localize') and self.widget == NumberInput:
        # Localized number input is not well supported on most browsers
        kwargs.setdefault('widget', super(IntegerField, self).widget)
    super(IntegerField, self).__init__(*args, **kwargs)

    # THESE LINES ARE THE PROBLEM
    if max_value is not None:
        self.validators.append(validators.MaxValueValidator(max_value))
    if min_value is not None:
        self.validators.append(validators.MinValueValidator(min_value))
</pre>
                        <br>
<p>
	As you can see, Django uses Validator objects, and evaluates them based on the field attributes that you set UPON INSTANTIATION. It basically side-steps the problem of having to write a bunch of redundant code in each of the validate methods for your field. It's a smart design if you never need to change validated attributes of a field. But if you do? the changes you make won't be reflected in the validators (it's an array that we never REALLY remove from) and the whole point of that nice subclassing and attribute changing is gone. For each field, we have a self.validators array, which we iterate through every time we call validate/clean(), and check for any errors. This WOULD be fine, except that django currenctly doesn't handle updating or clearing that array, so even if you make changes, the values set in __init__ stay there for the life of your field.
</p>

<p>
	There's some things YOU can do to get around this problem, 
                            <blockquote>but most of them are gross, like this:</blockquote>
</p>
      
<pre class = "brocode">	
class ProxyIntegerField(IntegerField):
    """
        This is gross and not DRY, i don't like it
    """
    def __init__(self):
        super(ProxyIntegerField, self)
        del self.validators[:]

    def validate(self, value):
        if value > self.max_value or value &lt; self.min_value: 
            raise ValidatorError("you messed up bro")
</pre>
                <br>
                <p>
	Sure you CAN get rid of validators and force the logic into your validate function, except that this is redundant, and trying to do the same thing as django validators. You'll have both approaches in your code and the whole solution isn't really reusable.
</p>
                <br>
                <p>
	You could do this too:
                    </p>
<pre class = "brocode">
class DamageControlPythonArticleComment(DamageControlCommentForm):
    def __init__(self, *args, **kwargs):
        super(DamageControlPythonArticleComment, self).__init__(*args, **kwargs)

    article_metacritic_score = Fields.IntegerField(
        min_value = 100 #top lel, writing the same code over again
    )
</pre>
                <br></br>
<p>
    Some might see this as a solution to the problem, and sure, it works. But as the Form you're working with grows larger and more complex, solving the issue this way becomes less feasable as you may need to change more fields. In a case where you.. say had 15 fields that you simply needed to update the max value on, It'd be nice to just iterate over a list of the field names instead of re-writing 15 different field definitions with the only difference being a single attribute.
</p>
            <br>
<p>
You could argue that the use case is esoteric, or that we're trying to do something that doesn't make sense in the first case (instance level manipulation of a form field). But this applies to ANY time you need dynamic validation attributes for a form that you don't want to write into your validate() method.
            </p>
            
            <br>
        
            <p>
    I personally think that Django should handle this problem, because there's an easy solution that fits ALL of these kind of dynamic update cases, but making it efficient might require some larger design changes. 
                </p>
            
            <p>The short version of the fix essentially looks like this: </p>
            
<pre class = "brocode">
# within some base field or In django.forms.fields.py
@property
def update_max_value(self):
    return self.max_value
    
@update_max_value.setter
def update_max_value(self, value):
        validator = [validator for validator in self.validators
                     if isinstance(validator, MaxValueValidator)].pop()
        self.validators[self.validators.index(validator)].limit_value = value
</pre>
            
            <p>This would be even simpler looking if field.validators was a dictionary. But I personally think it gets the job done. But I don't know, maybe this is horrible and you should never even need to do this anyway. Who knows?  </p>
                    
<br>
	<blockquote>(also interesting note. if you deepcopy() a form field it clears the validators..)</blockquote>
             ~ishygddt
            <br>

<button class = "btn btn-primary btn-large" onclick="window.location='blog-3.html'">Previous Blog</button>
		
                
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <script src="../js/jquery.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="../js/classie.js"></script>
    <script src="../js/cbpAnimatedHeader.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-62272037-1', 'auto');
      ga('send', 'pageview');

    </script>

</body>

</html>
